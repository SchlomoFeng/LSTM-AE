IBD2.1预警系统
使用手册




3、 算法开发介绍
3.1 算法入参类型说明
　　在IBD2.1版本的算法管理中增加部分功能，主要包括
1、 支持显示中文名称
2、 支持参数隐藏
3、 支持设置参数是否必填项
4、 支持复杂输入类型，例如json对象结构和数组里面嵌套json对象的结构。
　　目前确定算法参数类型为22种
1. str：字符串类型，传递给算法的参数为字符串，例如"aaa"


2.float：浮点型，传递给算法的参数为浮点的数值类型，例如1.1


3.double：双精度型，传递给算法的参数为浮点，例如1.1


4. int：整型，传递给算法的参数为整型的数值类型，例如1


5.bool：布尔型，传递给算法的参数为布尔类型，True或者False


6.dataFrame：锚点，传递给算法的参数为Spark.DataFrame，页面不显示
7.pyspark.sql.session.SparkSession：隐藏，传递给算法的参数为Spark对象，页面不显示
8.object：锚点，传递给算法的参数为python对象，页面不显示
9.list：自定义列表，传递给算法的参数为字符串形式自定义数组,列表内部元素为字符串，例如["1","2"]


10.dict：对象型，传递给算法的参数为dict对象,允许参数嵌套，例如{"a": "2","b": "3"}
11. timestamp：时间戳，传递给算法的参数为字符串形式时间戳，例如"1685600480000"


12. pdDataFrame：锚点，传递给算法的参数为字符串，页面不显示
13. json：对象型，传递给算法的参数为字典,允许参数嵌套，例如{"undefined":"2"}
14. nparray：锚点。
15. array：对象型，传递给算法的参数为字符串形式对象,允许参数嵌套，例如[{"undefined":"2"}]
16. enum：枚举单选类型，固定传入结构为"[{"value":"1","label":"男"},{"value":"0","label":"女"}]", 传递给算法的参数为字符串(选定一个对象value的值),例如"1"       


17. enum：枚举多选类型,传递给算法的参数为list,例如["北京","上海"]


18. tag: 位号下拉单选类型，需要调用查询位号接口，传递给算法的参数为字符串类型,例如"TI41123A.PV"。


19. tags：位号多选类型，需要调用查询位号接口,传递给算法的参数为list(str)类型,例如[“tag1”,“tag2”,“tag3”]。


20. tagEditor：位号表达式编辑类型，需要调用查询位号接口，传递给算法的参数为字符串,例如"tag1+tag2"，由算法自行取数和处理。


21. timeSelector：时间选择器类型，传递给算法的参数为dict类型，可设置默认值。

如果选择时间类型为"固定时间”，传递给算法参数例如为dict类型的{"timeType":"fixedtime", "timeInterval":"10"}，页面呈现形式如下所示：

如果选择时间类型为"时间段"，传递给算法参数例如为dict类型的{'timeType': 'timeQuantum', 'startTime': '2023-07-19 00:00:00', 'endTime': '2023-07-19 23:00:00'}"，页面呈现形式如下所示：

22. timeZone: 时间区间类型, 传递给算法的参数为list,例如"["2023-03-17 10:14:12","2023-03-17 12:14:12"]"


3.2 算法入参约定
1、由于需要通过预警项id来区分不同预警项返回的结果，因此算法入参中必须包含名为warningItemId的入参，在算法返回结果中也返回该预警项id。
2、追溯调参界面包括哪些子界面由预警算法参数确定：
　　如果预警算法参数包含参数名为"is_train"且"is_train"的值为"True"，则该预警项包括训练界面；
　　如果预警算法参数中包含参数名为"is_backtest"，则该预警项包括测试界面；
　　如果预警算法参数中包含参数名为"is_evaluate"且"is_evaluate"的值为True，则该预警项包括评价界面。
3、预警算法如果包含参数名为"is_backtest"的参数，在配置预警算法参数时由后端自动设置为"false"，在配置测试算法参数时由后端自动设置为"true"。
4、所有算法如果有参数名为"modelId"，由后端设置为预警项id。另外可根据后端提供接口，根据预警项id查询得到该预警项的预警算法、训练算法、测试算法和评估算法的任务id。
5、配置训练、测试和评价算法入参时，如果参数名和预警算法参数有相同的，该参数的值也直接将预警算法配置的参数值带过来，无需重新配置。特殊情况说明：配置测试算法参数时，如果包含"is_backtest"参数，该参数不要将预警算法的"is_backtest"参数值带过来。另外在测试界面点击“更新预警参数”按钮时，除"is_backtest"参数值外，其他同名参数回填。
6、"is_backtest"、"modelId"、"is_evaluate"、"is_train"在算法参数配置最好设置成不可见

3.3 算法出参约定
3.3.1 预警算法
算法出参规范
　　算法返回结果为json格式的str类型，键名为warningResult。返回结果中各字段的含义如下所示：
表 预警结果中各字段含义
字段名			含义					类型											是否必须
warningItemId		预警项id				str											必须
warningTime		预警时间，
				通常为取数对应时间		str、datetime64。								必须
									如果是str类型，
									时间形式需要为”yyyy-mm-dd HH:MM:SS”才能解析，
									例如”2022-12-11 20:19:11”。
									datetime64类型无限制。							
warningStatus		预警状态				str。											必须
				(”10”:正常”，		但可选值只有10,20,30,40.
				 ”20”:”通知”，
				 ”30”:“预警”，
				 ”40”:报警)			
									
warningReason	预警原因				str类型										非必须
warningTags		异常位号				str类型										非必须
otherInfo			其他信息				str											非必须
tagDetail			位号详情				List											非必须


　　tagDetail字段的具体内容如下所示
字段名			含义					类型											是否必须
warningTime		预警时间				str类型										非必须
warningTag		预警位号				str类型										非必须
tagValue			位号值				float类型										非必须
upperLimit		上限					float类型										非必须
lowerLimit		下限					float类型										非必须
predictValue		预测值数据			JsonArray类型									非必须


3.3.2 测试算法(追溯算法)
　　测试或者叫“追溯”，目的是将一个时间段范围的数据作为输入以及训练得到的模型(如果包含训练)作为输入，输出这一段时间的预警结果。例如，根据预测模型和数据作为输入，可以得到未来数据变化情况，根据判断未来是否超过上下限得到预警结果。这里测试算法无法选择，与预警算法相同。
　　测试算法返回结果为两个，“warningResult”和“warningReport”。
　　键值为“warningResult”对应测试可视化结果，数据类型为str类型。数据内容如下图所示，前端展示形式和预警监控界面趋势图完全相同。

　　键值为“warningReport”对应测试报告，数据类型为pd.DataFrame类型。数据内容不限，前端展示形式为表格。
　　由于测试算法和预警算法为同一算法，算法出参配置也相同。当执行预警算法时，warningReport应为None或者不包括该项，键名为warningResult的值可放入预警结果。当执行测试算法时，返回结果warningResult和warningReport。
3.3.3 训练算法
　　训练目的是通过对历史数据进行训练总结数据中规律，输出一个数据模型，例如预测位号未来一段变化的模型，以供预警算法使用。
　　训练算法返回结果三个，“modelUpdateTime”、“trainResult”和“trainReport”。
　　键值为“modelUpdateTime”对应模型更新时间，数据类型为字符串类型。
　　键值为“trainResult”对应“训练可视化”展示内容，数据类型为pd.DataFrame类型。数据内容如下图所示，前端展示形式和预警监控界面趋势图完全相同。
3.3.4 算法示例
　　常规的预警算法示例为warning_demo.py。

　　基于flink的预警算法示例为fink_warn_demo.py。唯一区别在于位号历史数据可以传递作为算法入参。目前约定由参数名为“inputTagData”的参数进行接收，inputTagData中涉及的位号来自于预警管理配置的预警位号，数据长度来自于flink配置的“数据时间窗口”。inputTagData的数据结构如下所示

　　
　　
　　键值为“trainReport”的对应训练报告，数据类型为pd.DataFrame类型。数据内容不限，前端展示形式为表格。

